[
  {
    "$match": {
      "network.active": true,
      "network.attributes.country": {
        "$exists": true
      }
    }
  },
  {
    "$unwind": {
      "path": "$network.detail.networkFacts"
    }
  },
  {
    "$set": {
      "fact": {
        "$switch": {
          "branches": [
            {
              "case": "$network.detail.networkFacts.networkExtraMemberNode",
              "then": [
                {
                  "name": "NetworkExtraMemberNodeNetworkCount",
                  "count": 1
                },
                {
                  "name": "NetworkExtraMemberNode",
                  "count": {
                    "$size": "$network.detail.networkFacts.networkExtraMemberNode"
                  }
                }
              ]
            },
            {
              "case": "$network.detail.networkFacts.networkExtraMemberWay",
              "then": [
                {
                  "name": "NetworkExtraMemberWayNetworkCount",
                  "count": 1
                },
                {
                  "name": "NetworkExtraMemberWay",
                  "count": {
                    "$size": "$network.detail.networkFacts.networkExtraMemberWay"
                  }
                }
              ]
            },
            {
              "case": "$network.detail.networkFacts.networkExtraMemberRelation",
              "then": [
                {
                  "name": "NetworkExtraMemberRelationNetworkCount",
                  "count": 1
                },
                {
                  "name": "NetworkExtraMemberRelation",
                  "count": {
                    "$size": "$network.detail.networkFacts.networkExtraMemberRelation"
                  }
                }
              ]
            },
            {
              "case": "$network.detail.networkFacts.integrityCheck",
              "then": [
                {
                  "name": "IntegrityCheck",
                  "count": 1
                }
              ]
            },
            {
              "case": "$network.detail.networkFacts.integrityCheckFailed",
              "then": [
                {
                  "name": "IntegrityCheckFailed",
                  "count": 1
                }
              ]
            },
            {
              "case": "$network.detail.networkFacts.nameMissing",
              "then": [
                {
                  "name": "NameMissing",
                  "count": 1
                }
              ]
            }
          ],
          "default": []
        }
      }
    }
  },
  {
    "$unwind": {
      "path": "$fact"
    }
  },
  {
    "$group": {
      "_id": {
        "country": "$network.attributes.country",
        "networkType": "$network.attributes.networkType",
        "factName": "$fact.name"
      },
      "factCount": {
        "$sum": "$fact.count"
      }
    }
  },
  {
    "$project": {
      "_id": {
        "$concat": [
          "$_id.country",
          ":",
          "$_id.networkType",
          ":",
          "$_id.factName"
        ]
      },
      "country": "$_id.country",
      "networkType": "$_id.networkType",
      "name": "$_id.factName",
      "value": "$factCount"
    }
  },
  {
    "$merge": {
      "into": "statistics-network-detail-facts",
      "on": "_id"
    }
  }
]